# ZTE np05j (PQ84P01) - Next Steps for Porting

## Current Status

✅ **Completed:**
1. Device directory structure created
2. DeviceTreeBlob structure set up (Android/Linux subdirs)
3. PcdsFixedAtBuild.dsc.inc configured
4. Defines.dsc.inc created with MLVM enabled
5. Binaries and PatchedBinaries directories cleaned

## Required Steps to Complete Porting

### Step 1: Extract Firmware Binaries ⚠️ **CRITICAL**

The most important step - extract binaries from `np05j/uefi_a.img`:

#### Tools Needed:
- **UefiReader** - Download and compile from: https://github.com/WOA-Project/UEFIReader

#### Commands:
```bash
# If you have UefiReader compiled:
UefiReader np05j/uefi_a.img Platforms/KaanapaliPkg/Device/zte-np05j/Binaries/

# This will extract all the DXE drivers, libraries, and firmware components
```

#### What This Extracts:
- DXE drivers (all the .efi files)
- APRIORI load order
- DXE.inc file
- DXE.dsc.inc file

### Step 2: Process Device Tree Blob

Currently we have:
- ✅ `DeviceTreeBlob/Android/android-np05j.dtb` - placeholder (needs actual DTB from device)
- ✅ `DeviceTreeBlob/Linux/linux-np05j.dtb` - dummy file

#### To Get Android DTB:
Option 1 - From device:
```bash
adb shell su -c "cp /sys/firmware/fdt /sdcard/fdt"
adb pull /sdcard/fdt android-np05j.dtb
```

Option 2 - Extract from boot.img:
```bash
# Download magiskboot
# Extract boot.img from device
./magiskboot unpack boot.img
# Rename kernel_dtb or dtb to android-np05j.dtb
```

Option 3 - Use dtbo_a.img we already have:
```bash
# The file np05j/dtbo_a.img might be usable
# Try converting/extracting with dtc tools
```

### Step 3: Create Missing Configuration Files

After extracting binaries, you'll need to review and potentially edit:

#### 3.1 APRIORI.inc
This file defines the load order of DXE drivers.
- Will be generated by UefiReader
- Compare with other devices if needed
- Ensure critical drivers load first

#### 3.2 DXE.inc
This file includes all the DXE drivers and raw files.
- Will be generated by UefiReader
- May need manual adjustments for device-specific resources
- Check for device-specific BMP files, logos, etc.

#### 3.3 DXE.dsc.inc
This file declares which drivers to include in the build.
- Will be generated by UefiReader
- Review and ensure all needed drivers are included

### Step 4: Configure Libraries

Currently placeholder libraries exist. May need device-specific implementations:

#### 4.1 PlatformMemoryMapLib
**File**: `Library/PlatformMemoryMapLib/PlatformMemoryMapLib.c`

**Critical configurations:**
- RAM partition definitions
- Memory region base addresses and sizes
- Reserved memory regions

**How to find values:**
- Extract from device tree blob
- Reference SM8850 (similar SoC)
- May need adjustment based on bootloader behavior

#### 4.2 PlatformConfigurationMapLib
**File**: `Library/PlatformConfigurationMapLib/PlatformConfigurationMapLib.c`

**Configurations needed:**
- GPIO mappings (power button, volume buttons)
- PMIC settings
- USB configuration
- Display configuration

### Step 5: Build Initial Firmware

```bash
# Initialize build environment (if not done)
./build_setup.sh
pip install --upgrade -r pip-requirements.txt
./build_uefi.py --init

# Build for zte-np05j
./build_uefi.py -d zte-np05j -t DEBUG
```

#### Expected Build Issues:

**Missing binaries:**
- Resolve by completing Step 1 (UefiReader extraction)

**Missing library implementations:**
- Create minimal implementations or copy from similar device
- Adjust as needed during testing

**Configuration errors:**
- Review DXE files
- Check PCD definitions
- Verify GUIDs and paths

### Step 6: Initial Testing

```bash
# Test boot (non-permanent)
adb reboot bootloader
fastboot boot Build/KaanapaliPkg/zte-np05j.img
```

#### What to Expect:

**Success indicators:**
- Device powers on
- Display shows output
- UEFI Shell appears
- Can navigate with buttons

**Common issues:**
- Black screen → Display init failed (check resolution, SimpleFbDxe)
- Immediate reboot → Critical driver failure (check APRIORI, memory map)
- Hang during boot → Driver dependency issue (review load order)
- No response → Serious configuration error (may need recovery)

### Step 7: Iterative Debugging

1. **Enable DEBUG build** - Get detailed logs
2. **Review memory configuration** - Most common cause of issues
3. **Check device tree** - Ensure hardware configs match
4. **Patch binaries if needed** - See SimpleGuide.md Part 3

#### Binaries That Commonly Need Patching:
- **UFSDxe.efi** - If stack during PIL loading
- **UsbConfigDxe.efi** - If USB not working
- **ButtonsDxe.efi** - If buttons not working in UEFI

## Quick Reference Files

### Documentation:
- `Documentation/SimpleGuide.md` - Full porting guide
- `Documentation/DefinesGuidance.md` - Macros and defines
- `np05j/ANALYSIS.md` - Firmware analysis
- `np05j/PORTING_PLAN.md` - Detailed planning

### Source Firmware:
- `np05j/uefi_a.img` - ⭐ Extract binaries from this
- `np05j/xbl_a.img` - XBL bootloader (reference)
- `np05j/dtbo_a.img` - Device tree overlay

### Key Configurations:
- `PcdsFixedAtBuild.dsc.inc` - Device info, resolution
- `Defines.dsc.inc` - MLVM and other defines
- `Library/PlatformMemoryMapLib/` - Memory configuration
- `Library/PlatformConfigurationMapLib/` - Hardware config

## Critical Path Summary

1. **Extract binaries** from uefi_a.img using UefiReader ← **DO THIS FIRST**
2. **Get device tree** from device or boot.img
3. **Configure memory map** based on device specs
4. **Build** and fix compilation errors
5. **Test boot** and debug issues
6. **Patch binaries** if needed
7. **Iterate** until stable

## Tools Required

- [UefiReader](https://github.com/WOA-Project/UEFIReader) - Extract firmware binaries
- [magiskboot](https://github.com/TeamWin/external_magisk-prebuilt) - Extract DTB from boot
- `dtc` (device tree compiler) - Process device tree blobs
- `adb` and `fastboot` - Device communication and testing
- IDA/Ghidra - For binary patching (if needed)

## Getting Help

If you encounter issues:
1. Review `Documentation/SimpleGuide.md` thoroughly
2. Compare with similar devices (other SM8850 devices)
3. Check memory maps and device tree configurations
4. Ask in mu_aloha_platforms community

---

**Remember:** The most critical step is extracting binaries with UefiReader.
Without the actual firmware binaries from uefi_a.img, the build cannot complete.
